{"data":{"site":{"siteMetadata":{"title":"FENews"}},"markdownRemark":{"id":"5c16f5e8-def0-5269-8cac-78f53dc3dc4b","excerpt":"自从  React Hooks  发布 alpha 版本以来, 就有很多人开始讨论一些问题，比如: “为什么有些 API 不是一个 Hook?”。 比如下面这些就是一些 Hooks API：  可以用来声明   变量。  可以用来声明  。  可以用来读取  。 但是有些 API 就不是 hooks…","html":"<p>自从 <a href=\"https://reactjs.org/hooks\">React Hooks</a> 发布 alpha 版本以来, 就有很多人开始讨论一些问题，比如: “为什么有些 API 不是一个 Hook?”。</p>\n<p>比如下面这些就是一些 Hooks API：</p>\n<ul>\n<li><a href=\"https://reactjs.org/docs/hooks-reference.html#usestate\"><code class=\"language-text\">useState()</code></a> 可以用来声明 <code class=\"language-text\">state</code> 变量。</li>\n<li><a href=\"https://reactjs.org/docs/hooks-reference.html#useeffect\"><code class=\"language-text\">useEffect()</code></a> 可以用来声明 <code class=\"language-text\">side effects</code>。</li>\n<li><a href=\"https://reactjs.org/docs/hooks-reference.html#usecontext\"><code class=\"language-text\">useContext()</code></a> 可以用来读取 <code class=\"language-text\">context</code>。</li>\n</ul>\n<p>但是有些 API 就不是 hooks，比如 <code class=\"language-text\">React.memo()</code> 和 <code class=\"language-text\">&lt;Context.Provider&gt;</code>。一般大家提出来的关于 Hooks API 的提案基本上是<em>不可组合（noncompositional）</em>和<em>反模块化（antimodular）</em>的，这篇文章会帮助你理解为什么。</p>\n<p><strong>注：这篇文章是一篇深入探讨的文章，阅读对象应该是对 React API 的讨论是非常感兴趣的，而不是为了考虑使用 React 来提升效率的！</strong></p>\n<p>我们想让 React 的 API 保持以下非常重要的两点:</p>\n<ol>\n<li>\n<p><strong>组合:</strong> 对于 Hooks API来说，可以<a href=\"https://reactjs.org/docs/hooks-custom.html\">自定义 Hooks</a> 是让我们感到非常兴奋的。 我们期望大家都可以来构建自己的Hooks API， 并且我们需要确保不同人写的 Hooks API <a href=\"https://overreacted.io/why-do-hooks-rely-on-call-order/#flaw-4-the-diamond-problem\">不会造成冲突</a>。 (我们是不是已经被随意的组合组件而不用担心相互造成影响给惯坏了？)</p>\n</li>\n<li>\n<p><strong>调试:</strong> 我们希望随着应用规模的不断增长 <a href=\"https://overreacted.io/the-bug-o-notation/\">bug 是很容易发现的</a>的。React最棒的一个特性就是如果某些内容被错误的渲染了，你可以轻松的定位到对应组件中的 prop 或者 state 导致了这个问题。</p>\n</li>\n</ol>\n<p>结合这两点来看，我们就可以知道哪些可以或者<em>不可以</em>成为一个 Hook。我们可以用一些例子来说明：</p>\n<h2>一个 Hook：<code class=\"language-text\">useState()</code></h2>\n<h3>组合</h3>\n<p>多个自定义的 Hooks 调用 <code class=\"language-text\">useState()</code>，而不会造成冲突：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">useMyCustomHook1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// What happens here, stays here.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useMyCustomHook2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// What happens here, stays here.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">MyComponent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useMyCustomHook1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useMyCustomHook2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>添加一个不在条件判断里的 <code class=\"language-text\">useState()</code> ， 调用这个 API 是很安全的。你不需要了解在一个组件里面声明了新的 state 变量被其他 Hooks 使用了。也不会因为更新了其他状态导致 state 变量被影响。</p>\n<p><strong>结论:</strong> ✅ <code class=\"language-text\">useState()</code> 不会对其他自定义的 Hooks 造成影响。 </p>\n<h3>调试</h3>\n<p>Hooks 是非常有用的，你可以在 Hooks <em>之间</em>传递值：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">return</span> width<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useTheme</span><span class=\"token punctuation\">(</span>isMobile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Comment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isMobile <span class=\"token operator\">=</span> width <span class=\"token operator\">&lt;</span> <span class=\"token constant\">MOBILE_VIEWPORT</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> theme <span class=\"token operator\">=</span> <span class=\"token function\">useTheme</span><span class=\"token punctuation\">(</span>isMobile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>section className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>theme<span class=\"token punctuation\">.</span>comment<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>section<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>但是如过我们的代码出错了，我们怎么调试？</p>\n<p>假设我们从 <code class=\"language-text\">theme.comment</code> 里拿出来的一个 css class 是错误的, 那我们怎么调试这个问题？我们可以在组件里设置一个断点或者输出一些日志。</p>\n<p>也许我们可以发现 <code class=\"language-text\">theme</code> 是错误的，但是 <code class=\"language-text\">width</code> 和 <code class=\"language-text\">isMobile</code>是正确的。这就告诉我们问题是发生在 <code class=\"language-text\">useTheme()</code> 里面。也有可能 <code class=\"language-text\">width</code> 不对，那么相应的问题就出在 <code class=\"language-text\">useWindowWidth()</code> 里。</p>\n<p><strong>一看最顶部的对应 Hooks 里的中间值就知道问题发生在哪里了。</strong> 我们不需要查看组件里所有的 Hooks 的实现。</p>\n<p>我们直接查看有问题的那个实现，重复这个步骤就可以确定问题具体问题发生在什么地方。</p>\n<p>如果自定义 Hooks 的嵌套层级增加了，那么这个就变的更加重要。想象一下，我们有三层嵌套的自定义 Hook，每层使用了三个不同的自定 Hooks。 定位<strong>3个有问题的地方</strong>和定位 <strong>3 + 3×3 + 3×3×3 = 39个有问题地方</strong>，二者之间的成本<a href=\"https://overreacted.io/the-bug-o-notation/\">差别</a>是非常大的。幸运的是，<code class=\"language-text\">useState()</code> 不会对其他 Hooks 或者组件造成莫名其妙的影响。雁过留痕，一个 Hooks 返回的错误值，和普通的变量是没有任何区别的。🐛</p>\n<p><strong>结论:</strong> ✅ <code class=\"language-text\">useState()</code> 不会隐藏我们代码中的因果关系。我们可以一步步的定位到对应的bug。</p>\n<h2>不是一个 Hook: <code class=\"language-text\">useBailout()</code></h2>\n<p>作为一种优化, 组件使用 Hooks 可以避免重新渲染。</p>\n<p>另一种方式是我们可以使用 <a href=\"https://reactjs.org/blog/2018/10/23/react-v-16-6.html#reactmemo\"><code class=\"language-text\">React.memo()</code></a> 包裹整个组件。 为了避免重新渲染，<code class=\"language-text\">React.memo()</code> 会用本次即将渲染的 props 和最后一次渲染的 props 通过 <code class=\"language-text\">shallowly equal</code> 去做比较， 这个和 <code class=\"language-text\">PureComponent</code> 是类似的。</p>\n<p><code class=\"language-text\">React.memo()</code> 接收一个组件作为参数并返回一个组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Button</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">memo</span><span class=\"token punctuation\">(</span>Button<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>但是 <code class=\"language-text\">useBailout()</code> 为什么不仅仅是一个钩子</strong></p>\n<p>不论你将其称之为 <code class=\"language-text\">useShouldComponentUpdate()</code>， <code class=\"language-text\">usePure()</code>， <code class=\"language-text\">useSkipRender()</code> 或者 <code class=\"language-text\">useBailout()</code>， 这个提案(proposal)看起来就和下面这个是一样的：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">Button</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> color <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ⚠️ 非真实API</span>\n  <span class=\"token function\">useBailout</span><span class=\"token punctuation\">(</span>prevColor <span class=\"token operator\">=></span> prevColor <span class=\"token operator\">!==</span> color<span class=\"token punctuation\">,</span> color<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>button className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'button-'</span> <span class=\"token operator\">+</span> color<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>  \n      <span class=\"token constant\">OK</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>也有一些其他不同的提案（比如：<a href=\"https://github.com/reactjs/rfcs/pull/30#issuecomment-371337630\"><code class=\"language-text\">usePure()</code></a>），但是一般来说，这个提案也有同样的问题。</p>\n<h3>组合</h3>\n<p>让我们尝试将 <code class=\"language-text\">useBailout()</code> 在两个自定义的 Hooks 中使用：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isOnline<span class=\"token punctuation\">,</span> setIsOnline<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ⚠️ 非真实API</span>\n  <span class=\"token function\">useBailout</span><span class=\"token punctuation\">(</span>prevIsOnline <span class=\"token operator\">=></span> prevIsOnline <span class=\"token operator\">!==</span> isOnline<span class=\"token punctuation\">,</span> isOnline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleStatusChange</span> <span class=\"token operator\">=</span> status <span class=\"token operator\">=></span> <span class=\"token function\">setIsOnline</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">.</span>isOnline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    ChatAPI<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">,</span> handleStatusChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> ChatAPI<span class=\"token punctuation\">.</span><span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">,</span> handleStatusChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> isOnline<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// ⚠️ 非真实API</span>\n  <span class=\"token function\">useBailout</span><span class=\"token punctuation\">(</span>prevWidth <span class=\"token operator\">=></span> prevWidth <span class=\"token operator\">!==</span> width<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setWidth</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> width<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果现在在同一个组件中使用这两个自定义的 Hooks 会发生什么？</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">ChatThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> friendID<span class=\"token punctuation\">,</span> isTyping <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isOnline <span class=\"token operator\">=</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ChatLayout width<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>FriendStatus isOnline<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>isOnline<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>isTyping <span class=\"token operator\">&amp;&amp;</span> <span class=\"token string\">'Typing...'</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ChatLayout<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>什么时候重新渲染?</p>\n<p>如果每一个 <code class=\"language-text\">useBailout()</code> 都有权限去跳过更新，那么 <code class=\"language-text\">useWindowWidth()</code> 里面的更新就会被 <code class=\"language-text\">useFriendStatus()</code> 给阻塞，反之亦然。 <strong>这些 Hooks 会相互影响。</strong></p>\n<p>然而，如果允许<code class=\"language-text\">useBailout()</code> 在一个组件里去阻止更新的话，那么我们的 <code class=\"language-text\">ChatThread</code> 组件里的 <code class=\"language-text\">isTyping</code> 属性发生变化时也无法去更新这个组件。</p>\n<p>更糟糕的是，如果我们使用这种语义，<strong>任何新添加到 <code class=\"language-text\">ChatThread</code> 里的 Hooks 如果没有<em>同样</em>调用 <code class=\"language-text\">useBailout()</code>，那么这些 Hooks 也同样会被阻断</strong>。不然 <code class=\"language-text\">useBailout()</code> 也没有办法在 <code class=\"language-text\">useWindowWidth()</code> 和 <code class=\"language-text\">useFriendStatus()</code> 阻止更新时 “投上反对票（vote against）”。</p>\n<p><strong>结论:</strong> 🔴 <code class=\"language-text\">useBailout()</code> 违反了组合原则。添加 <code class=\"language-text\">useBailout()</code> 到一个 Hook 里面就会影响其他 Hooks 的状态更新。我希望 API 是<a href=\"https://overreacted.io/optimized-for-change/\">健壮的(antifragile)</a>, 但是 <code class=\"language-text\">useBailout()</code> 的行为是完完全全相反的。</p>\n<h3>调试</h3>\n<p>像 <code class=\"language-text\">useBailout()</code> 的这样的 hook 会对调试造成什么影响？</p>\n<p>我们使用同样的列子:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">ChatThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> friendID<span class=\"token punctuation\">,</span> isTyping <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isOnline <span class=\"token operator\">=</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>ChatLayout width<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>FriendStatus isOnline<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>isOnline<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">{</span>isTyping <span class=\"token operator\">&amp;&amp;</span> <span class=\"token string\">'Typing...'</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ChatLayout<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>假设有些上层组件的属性发生了变化，但是 <code class=\"language-text\">Typing...</code> label 没有按照我们预期显示出来。这时候我们怎么调试呢？</p>\n<p><strong>通常，你会很自信的回答这个问题，我们只需要去看<em>上层组件</em>。</strong> 如果 <code class=\"language-text\">ChatThread</code> 没有获得 <code class=\"language-text\">isTyping</code> 的新值。我们可以打开渲染 <code class=\"language-text\">&lt;ChatThread isTyping={myVar} /&gt;</code> 的组件，然后去检查 <code class=\"language-text\">myVar</code> 等等。在同级组件中，我们可能在 <code class=\"language-text\">shouldComponentUpdate()</code> 中发现被阻止了，或者 <code class=\"language-text\">isTyping</code> 的值没有正确的传递过去。检查在这个链中的每一个组件通常也能轻松的定位到问题的根源。</p>\n<p>如果 <code class=\"language-text\">useBailout()</code> Hook 是一个真实的 API。在你深度地检查 <code class=\"language-text\">ChatThread</code> 和所有组件<em>中使用到的每一个自定义 Hook</em> 之前，你永远不知道跳过更新的原因。由于每一个父组件<em>同样</em>可以使用自定义 Hooks，这个<a href=\"https://overreacted.io/the-bug-o-notation/\">情况（scales）</a>就变的更加复杂了。</p>\n<p>这就像一个抽屉柜里有一堆小抽屉，你需要在其中一个找到一把小螺丝刀一样。你永远不知道这个“坑”到底有多深。</p>\n<p><strong>结论:</strong> 🔴 <code class=\"language-text\">useBailout()</code> Hook 不仅仅破坏可组合性, 为了找到有 bug 的阻止更新代码，大大的增加了调试步骤和认知负荷 —— 在某些情况下，这是指数级别的。</p>\n<p>我们讨论了一个真正存在的 Hook - <code class=\"language-text\">useState()</code>，和另一个看上去是 Hook，但是实际上<em>不</em>是一个 Hook - <code class=\"language-text\">useBailout()</code> 的例子，我们通过一些组合和调试列子比较了一下，并讨论了为什么其中一个是有效的，另一个是无效的。</p>\n<p>虽然没有 “Hook 版本” 的 <code class=\"language-text\">memo()</code> 和 <code class=\"language-text\">shouldComponentUpdate()</code>，但是React确实提供了一个叫 <a href=\"https://reactjs.org/docs/hooks-reference.html#usememo\"><code class=\"language-text\">useMemo()</code></a> 的 API. 虽然有相同的用途，但是 <code class=\"language-text\">useMemo()</code> 本身的语义是不一样的，不会遇到上面所说的问题。</p>\n<p><code class=\"language-text\">useBailout()</code> 只是一个不会像 Hook 一样工作的例子。但是也还有一些其他的 Hooks API —— 比如，<code class=\"language-text\">useProvider()</code>, <code class=\"language-text\">useCatch()</code>, 和 <code class=\"language-text\">useSuspense()</code>。</p>\n<p>现在明白为什么了吗?</p>\n<p><em>(低头嘀咕: 组合… 调试…)</em></p>\n<p>原文地址：<a href=\"https://overreacted.io/why-isnt-x-a-hook/\">https://overreacted.io/why-isnt-x-a-hook/</a></p>","frontmatter":{"title":"「译」为什么 'XX' 不是一个 Hooks API?","date":"2019年01月30日, ","description":"我们可以这样做，但并不是意味着我们应该这样做。","translators":null,"tags":["React","React Hooks","翻译"]}}},"pageContext":{"slug":"/2019-01-30---why-x-is-not-a-hook/","previous":{"fields":{"slug":"/2019-01-24---the-Orinoco-garbage-collector/"},"frontmatter":{"title":"「译」Orinoco: V8的垃圾回收器"}},"next":{"fields":{"slug":"/2019-01-31---javascript-performance-test/"},"frontmatter":{"title":"「译」JavaScript 性能测试- 比较 for/ forEach/ map/ reduce/ filter/ find"}}}}