{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog","author":"Kyle Mathews"}},"markdownRemark":{"id":"3d21a905-bdb6-51e6-8662-00a9d5b201dd","excerpt":"\n这可能是一台非常古老的状态机。  拍摄  当我看到有人在 Twitter 上发布他们带有激情的项目时，我心里有点嫉妒他们。 ✨ \n这些项目通常都包含很多花俏的技术，GraphQL…","html":"<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36839ff0ce01d5d029d9b3c3d553fd95/8f220/poster.jpeg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.45%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBBAb/xAAVAQEBAAAAAAAAAAAAAAAAAAABA//aAAwDAQACEAMQAAABVX1sppRQTf/EABkQAQADAQEAAAAAAAAAAAAAAAEAAhESBP/aAAgBAQABBQKuk8/FnpmwcaOn/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8BR//EABYRAQEBAAAAAAAAAAAAAAAAAAAREv/aAAgBAgEBPwFqP//EABsQAAIBBQAAAAAAAAAAAAAAAAABEQIQIXGB/9oACAEBAAY/AiOmFS9si/8A/8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFRccH/2gAIAQEAAT8h5Gh7Nnn1BTG7CDyECo96F3P/2gAMAwEAAgADAAAAEFQP/8QAFREBAQAAAAAAAAAAAAAAAAAAACH/2gAIAQMBAT8QU//EABgRAAMBAQAAAAAAAAAAAAAAAAABIREx/9oACAECAQE/EHVB8MP/xAAbEAEBAAIDAQAAAAAAAAAAAAABEQAhMUFRgf/aAAgBAQABPxBJKHZFfmNBtkDujq+TCcxTcO8Z4Jjg0ZyOMdwVDnP/2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"poster\"\n        title=\"\"\n        src=\"/static/36839ff0ce01d5d029d9b3c3d553fd95/44e84/poster.jpeg\"\n        srcset=\"/static/36839ff0ce01d5d029d9b3c3d553fd95/68355/poster.jpeg 148w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/ada22/poster.jpeg 295w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/44e84/poster.jpeg 590w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/274de/poster.jpeg 885w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/060c5/poster.jpeg 1180w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/9b205/poster.jpeg 1770w,\n/static/36839ff0ce01d5d029d9b3c3d553fd95/8f220/poster.jpeg 2000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n这可能是一台非常古老的状态机。<code class=\"language-text\">Chester Alvarez</code> 拍摄 <code class=\"language-text\">Unsplash</code></p>\n<p>当我看到有人在 Twitter 上发布他们带有激情的项目时，我心里有点嫉妒他们。 ✨\n这些项目通常都包含很多花俏的技术，GraphQL，超一流的互动动画或者令人惊叹的性能。在我的日常工作中，我不处理任何这样的问题。我处理获取数据的问题。</p>\n<h3>真实项目中的现状</h3>\n<p>当我在一个容器组件里获取数据时（比如说，一个个人用户资料页面），我知道该怎么去做。我已经做过成千上万次了。我写了一个组件，初始化了 state 里的三个值一般都叫做 <code class=\"language-text\">data</code>，<code class=\"language-text\">error</code> 和 <code class=\"language-text\">loading</code>。当组件 <code class=\"language-text\">mounts</code> 的时候我去获取数据，然后根据一些渲染条件完成一些样板数据，以便根据不用的 <code class=\"language-text\">state</code> 渲染不同的东西。 </p>\n<p>就像这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SomePage</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        isPending<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        error<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n        result<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            isPending<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            error<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            result<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/some-data'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                error<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n                result<span class=\"token punctuation\">:</span> data\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                error<span class=\"token punctuation\">:</span> e<span class=\"token punctuation\">,</span>\n                result<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            isPending<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Renders the appropriate thing based on all of that state</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里有很多的 <code class=\"language-text\">state</code>，而且他们看起来长的都一样。每次都是这样很烦。每当我写这个时候，我肯定会忘记重置某种特定情况下的 <code class=\"language-text\">state</code> 的一些值。</p>\n<h3>状态机</h3>\n<p>让我们创建一个状态机，让我们的工作变得轻松点。</p>\n<p>每一个数据获取的组件都可能处于四个 <code class=\"language-text\">state</code> 其实中的一个—它可能处在空闲（<code class=\"language-text\">idle</code>）的状态，<code class=\"language-text\">pending</code> 状态，成功（<code class=\"language-text\">successful</code>）的状态或者是错误（<code class=\"language-text\">erroneous</code>）的状态。从空闲的状态到 <code class=\"language-text\">pending</code> 的状态，从 <code class=\"language-text\">pending</code> 的状态到成功或者错误的状态。当这个时候，你可以根据需要将 <code class=\"language-text\">state</code> 的状态重置。</p>\n<p>这个看起来有点像状态机。我必须承认我对状态机的理论知识了解的有限，但是 <a href=\"https://medium.freecodecamp.org/state-machines-basics-of-computer-science-d42855debc66\">Mark Shead</a>（<a href=\"https://medium.freecodecamp.org/state-machines-basics-of-computer-science-d42855debc66%EF%BC%89\">https://medium.freecodecamp.org/state-machines-basics-of-computer-science-d42855debc66）</a> 的这篇文章给了我很大的帮助。如果你像我一样，我建议你花几分钟时间略读一下这篇文章。</p>\n<p>那么让我们开始构建我们的状态机吧。下面是一个简单的例子。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ApiStateMachine</span> <span class=\"token punctuation\">{</span>\n    state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        current<span class=\"token punctuation\">:</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> nextState<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">:</span>\n                nextState <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">:</span>\n                nextState <span class=\"token operator\">=</span> input <span class=\"token operator\">?</span> <span class=\"token string\">'success'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n                nextState <span class=\"token operator\">=</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current <span class=\"token operator\">=</span> nextState<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>就像你看到的这样，这里其实没有做过多的事情。你基于 <code class=\"language-text\">ApiStateMachine</code> 创建了某个 实例，当你想用是状态机改变 <code class=\"language-text\">state</code> 的状态的时候调用 <code class=\"language-text\">next()</code> 方法。这个方法需要提供一个 <code class=\"language-text\">input</code> 的参数，用来表明成功与否。</p>\n<blockquote>\n<p><em>重点是 state 有一种状态，而且必须只有一种状态—它不能是 <code class=\"language-text\">pending</code> 状态还包含一个错误的状态，或者是空闲状态还包含一个正确的值。你永远都不会忘记 <code class=\"language-text\">state</code> 中的状态值了。</em></p>\n</blockquote>\n<h3>我能在 React 中用吗？</h3>\n<p>答案是 <code class=\"language-text\">Yes</code>。要把它写的更 <code class=\"language-text\">React</code> 化，我们把它放入到一个高阶组件里：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">withApiState</span> <span class=\"token operator\">=</span> TargetComponent <span class=\"token operator\">=></span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">extends</span> React<span class=\"token punctuation\">.</span>Component <span class=\"token punctuation\">{</span>\n        state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            current<span class=\"token punctuation\">:</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> nextState<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">case</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">:</span>\n                    nextState <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">case</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">:</span>\n                    nextState <span class=\"token operator\">=</span> input <span class=\"token operator\">?</span> <span class=\"token string\">'success'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n                    nextState <span class=\"token operator\">=</span> <span class=\"token string\">'idle'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                current<span class=\"token punctuation\">:</span> nextState\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">&lt;</span>\n                TargetComponent <span class=\"token punctuation\">{</span>\n                    <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props\n                <span class=\"token punctuation\">}</span>\n                apiState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span>\n                        next<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>next\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<p>这个高阶组件接受一个组件，然后返回一个新的组件，这个返回的新组件提供状态机的所有的 <code class=\"language-text\">state</code> 和改变 <code class=\"language-text\">state</code> 的方法 <code class=\"language-text\">next</code>。</p>\n<p>用这种方法，我们可以重构我们大部分获取数据的组件：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SomePage</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n            apiState\n        <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n        apiState<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/some-data'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            apiState<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            apiState<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Renders the appropriate thing based on props!</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> SomeBetterPage <span class=\"token operator\">=</span> <span class=\"token function\">withApiState</span><span class=\"token punctuation\">(</span>SomePage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>改进 API</h3>\n<p>现在代码看起来非常的干净，简洁！我唯一不满意的地方就是这个 <code class=\"language-text\">next</code> 方法。从表面上不容易看来它是怎么工作的。</p>\n<p>我们可以暴露 .pending()， .success()，.error 方法，还有一个 .idle() 方法，而不是一个不可描述的 .next() 方法。虽然上面的想法没有实现，但是如果我们无序调用它们的话，我们的高阶组件（HOC）也可以确保警告我们—这样可以确保状态机特征对我们有用。</p>\n<p>最重要的是，我们仍然隐藏了可重用 <code class=\"language-text\">HOC</code> 中所有状态处理的复杂性。这是 <code class=\"language-text\">API</code> 状态机的最终简洁版本：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">withApiState</span> <span class=\"token operator\">=</span> TargetComponent <span class=\"token operator\">=></span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">extends</span> React<span class=\"token punctuation\">.</span>Component <span class=\"token punctuation\">{</span>\n        state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            current<span class=\"token punctuation\">:</span> <span class=\"token string\">\"idle\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        apiState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            pending<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                current<span class=\"token punctuation\">:</span> <span class=\"token string\">\"pending\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            success<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                current<span class=\"token punctuation\">:</span> <span class=\"token string\">\"success\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            error<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                current<span class=\"token punctuation\">:</span> <span class=\"token string\">\"error\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            idle<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                current<span class=\"token punctuation\">:</span> <span class=\"token string\">\"idle\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            isPending<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current <span class=\"token operator\">===</span> <span class=\"token string\">\"pending\"</span><span class=\"token punctuation\">,</span>\n            isSuccess<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current <span class=\"token operator\">===</span> <span class=\"token string\">\"success\"</span><span class=\"token punctuation\">,</span>\n            isError<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current <span class=\"token operator\">===</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span>\n            isIdle<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>current <span class=\"token operator\">===</span> <span class=\"token string\">\"idle\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>TargetComponent <span class=\"token punctuation\">{</span>\n                <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props\n            <span class=\"token punctuation\">}</span>\n            apiState <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>apiState\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>你可以这样使用它：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">SomePage</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> apiState <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n    apiState<span class=\"token punctuation\">.</span><span class=\"token function\">pending</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/some-data'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      apiState<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      apiState<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Renders the appropriate thing based on props!</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> SomeBetterPage <span class=\"token operator\">=</span> <span class=\"token function\">withApiState</span><span class=\"token punctuation\">(</span>SomePage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>读起来很6，不是吗？我也是这么认为的。</p>\n<p>下面的链接有个简单的应用，你可以试试。\n<a href=\"https://codesandbox.io/s/rj5yoq23lq?from-embed\">https://codesandbox.io/s/rj5yoq23lq?from-embed</a></p>\n<h3>我可以做的更多吗？</h3>\n<p>当然，我们可以做很多很酷的事情来改进这种天真的实现，包括添加类型，<code class=\"language-text\">dev-only</code> 的警告以及可能稍微更精细的 <code class=\"language-text\">API</code>。如果你愿意的话，你也可以让它为你处理错误信息，或者甚至是真实的数据获取。</p>\n<p>关于高阶组件—还有 <code class=\"language-text\">React</code> 组件 的比较酷的事情是组合使用。因此，比起写一个什么都做的组件而言，你可以编写几个较小的实用程序，把它们组合起来使用，来做任何给定情况下，你需要它们执行的操作。</p>\n<p>这里是我实现的一个叫 <code class=\"language-text\">withData</code> 的处理实际的数据获取和异步获取内容的高阶组件。现在，我们实际的页面组件可以是无状态的，并且数据获取的逻辑是可共享的。</p>\n<p><a href=\"https://codesandbox.io/s/x72q63v4rq?from-embed\">https://codesandbox.io/s/x72q63v4rq?from-embed</a></p>\n<p>这里，<code class=\"language-text\">withData</code> 高阶组件使用 <code class=\"language-text\">withApiState</code> 高阶组件来处理一般用例，同时让 <code class=\"language-text\">withApiState</code> 也可以为自己重用。</p>\n<h3>总结</h3>\n<p>将像通过 API 获取数据这种可以重用的逻辑分离出来可以省去你很多麻烦。如果你创建一个高阶组件来处理所有的诸如此类的事情, 你可以在一个地方解决一次，并在任何地方重复使用它。</p>\n<p><em>原文地址： <a href=\"https://blog.usejournal.com/handling-data-fetching-with-state-machines-4e25b6366d9\">https://blog.usejournal.com/handling-data-fetching-with-state-machines-4e25b6366d9</a></em></p>","frontmatter":{"title":"「译」使用状态机管理获取的数据","date":"February 20, 2019","description":"使用状态机管理获取的数据"}}},"pageContext":{"slug":"/2019-02-10---Handling-data-fetching-with-state-machines/","previous":{"fields":{"slug":"/2019-02-16---V8-release-v7.3/"},"frontmatter":{"title":"「译」V8 release v7.3"}},"next":{"fields":{"slug":"/2019-02-22---Flutter-for-JavaScript-Developers/"},"frontmatter":{"title":"「译」为 JavaScript 开发者准备的 Flutter 指南"}}}}